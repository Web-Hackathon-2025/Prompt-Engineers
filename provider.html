<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Provider Dashboard - Karigar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Modern Header -->
  <nav class="navbar">
    <div class="container navbar-content">
      <a href="index.html" class="navbar-brand">
        <span class="brand-icon">ğŸ› ï¸</span>
        <span class="brand-name">Karigar</span>
      </a>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <span style="color: var(--text-secondary); font-weight: 500;">ğŸ‘¤ <span id="userName">Provider</span></span>
        <button class="btn btn-sm btn-outline-sm" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>
  
  <!-- Main Content -->
  <main style="min-height: 100vh; background: var(--bg-secondary); padding: 2rem 0;">
    <div class="container">
      <!-- Page Header -->
      <div style="margin-bottom: 2rem;">
        <h1 style="margin-bottom: 0.5rem;">Provider Dashboard</h1>
        <p style="color: var(--text-secondary); font-size: 1.125rem; margin: 0;">Manage your service requests and grow your business</p>
      </div>
      
      <!-- Stats Cards -->
      <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card" style="background: linear-gradient(135deg, #E0B4B2 0%, #f0c4c2 100%); border: none;">
          <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
          <div class="stat-value" id="statPending" style="color: #622347;">0</div>
          <div class="stat-label" style="color: #622347;">Pending Requests</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #ABAFB5 0%, #bfc3c9 100%); border: none;">
          <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”§</div>
          <div class="stat-value" id="statActive" style="color: #122E34;">0</div>
          <div class="stat-label" style="color: #122E34;">Active Jobs</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #677E8A 0%, #7a909d 100%); border: none;">
          <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">âœ…</div>
          <div class="stat-value" id="statCompleted" style="color: #ffffff;">0</div>
          <div class="stat-label" style="color: #ffffff;">Completed Jobs</div>
        </div>
        
        <div class="stat-card" style="background: linear-gradient(135deg, #622347 0%, #7a2d59 100%); border: none;">
          <div class="stat-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">â­</div>
          <div class="stat-value" id="statRating" style="color: #E0B4B2;">0</div>
          <div class="stat-label" style="color: #E0B4B2;">Average Rating</div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs" data-tabs>
        <button class="tab active" data-tab="requestsTab">ğŸ“‹ Service Requests</button>
        <button class="tab" data-tab="historyTab">ğŸ“– History</button>
        <button class="tab" data-tab="reviewsTab">â­ Reviews</button>
        <button class="tab" data-tab="profileTab">ğŸ‘¤ My Profile</button>
      </div>
      
      <!-- Service Requests Tab -->
      <div id="requestsTab" class="tab-content active">
        <div id="requestsList">
          <!-- Dynamically populated -->
        </div>
        
        <div id="noRequestsMessage" class="empty-state hidden">
          <div class="empty-state-icon">ğŸ“‹</div>
          <p class="empty-state-message">No pending service requests at the moment.</p>
        </div>
      </div>
      
      <!-- History Tab -->
      <div id="historyTab" class="tab-content">
        <div id="historyList">
          <!-- Dynamically populated -->
        </div>
        
        <div id="noHistoryMessage" class="empty-state hidden">
          <div class="empty-state-icon">ğŸ“–</div>
          <p class="empty-state-message">No completed bookings yet.</p>
        </div>
      </div>
      
      <!-- Reviews Tab -->
      <div id="reviewsTab" class="tab-content">
        <div id="reviewsList">
          <!-- Dynamically populated -->
        </div>
        
        <div id="noReviewsMessage" class="empty-state hidden">
          <div class="empty-state-icon">â­</div>
          <p class="empty-state-message">No reviews yet. Complete jobs to receive reviews from customers.</p>
        </div>
      </div>
      
      <!-- Profile Tab -->
      <div id="profileTab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">My Profile</h3>
          </div>
          
          <div class="card-body">
            <div class="grid grid-2">
              <div>
                <p><strong>Name:</strong> <span id="profileName"></span></p>
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
                <p><strong>Location:</strong> <span id="profileLocation"></span></p>
              </div>
              
              <div>
                <p><strong>Services:</strong> <span id="profileServices"></span></p>
                <p><strong>Availability:</strong> <span id="profileAvailability"></span></p>
                <p><strong>Status:</strong> <span id="profileStatus"></span></p>
                <p><strong>Member Since:</strong> <span id="profileMemberSince"></span></p>
              </div>
            </div>
            
            <div style="margin-top: 1.5rem;">
              <p><strong>About:</strong></p>
              <p id="profileBio" style="color: var(--text-medium);"></p>
            </div>
            
            ${/*
            <div class="alert alert-info" style="margin-top: 1.5rem;">
              <strong>ğŸ’¡ Tip:</strong> To update your profile, please contact admin support.
            </div>
            */ ''}
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- Firebase Configuration -->
  <script src="firebase-config.js"></script>
  
  <!-- Database Utilities -->
  <script src="db-utils.js"></script>
  <script src="firebase-auth.js"></script>
  
  <!-- Core Logic and AI -->
  <script src="script-firestore.js"></script>
  <script src="ai/aiLogic.js"></script>
  <script>
    // Check authentication
    const currentUser = getCurrentUser();
    if (!currentUser || currentUser.role !== 'provider') {
      window.location.href = 'index.html';
    }
    
    // Display user name
    document.getElementById('userName').textContent = currentUser.name;
    
    // Load stats
    function loadStats() {
      const requests = getRequestsByProvider(currentUser.id);
      const reviews = getReviewsByProvider(currentUser.id);
      
      const pending = requests.filter(r => r.status === 'requested').length;
      const active = requests.filter(r => r.status === 'confirmed').length;
      const completed = requests.filter(r => r.status === 'completed').length;
      const avgRating = reviews.length > 0 ? getProviderAverageRating(currentUser.id) : (currentUser.rating || 0);
      
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statRating').textContent = parseFloat(avgRating).toFixed(1);
    }
    
    // Load service requests (requested status only)
    function loadRequests() {
      const requests = getRequestsByProvider(currentUser.id)
        .filter(r => r.status === 'requested' || r.status === 'confirmed');
      
      const container = document.getElementById('requestsList');
      const noMessage = document.getElementById('noRequestsMessage');
      
      if (requests.length === 0) {
        container.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
      }
      
      noMessage.classList.add('hidden');
      
      // Sort by most recent first
      requests.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      
      container.innerHTML = requests.map(request => `
        <div class="card" style="margin-bottom: 1rem;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h3 class="card-title" style="margin-bottom: 0.25rem;">ğŸ”§ ${request.service}</h3>
              <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Customer: <strong>${request.customerName}</strong></p>
            </div>
            ${getStatusBadge(request.status)}
          </div>
          
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
              <div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 0.25rem;">Description</div>
                <div style="font-size: 0.9375rem; color: var(--text-primary);">${request.description}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 0.25rem;">Scheduled</div>
                <div style="font-size: 0.9375rem; color: var(--text-primary);">ğŸ“… ${formatDateOnly(request.preferredDate)} â° ${request.preferredTime}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 0.25rem;">Location</div>
                <div style="font-size: 0.9375rem; color: var(--text-primary);">ğŸ“ ${request.location}</div>
              </div>
            </div>
            
            <div class="alert alert-${request.status === 'requested' ? 'warning' : 'info'}" style="padding: 0.75rem; font-size: 0.875rem;">
              ${request.status === 'requested' ? 'â³ <strong>Action Required:</strong> Please accept or reject this request' : 'âœ“ <strong>Confirmed:</strong> Job is confirmed and scheduled'}
            </div>
            
            ${request.timeline && request.timeline.length > 0 ? `
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <strong style="color: var(--text-primary); display: block; margin-bottom: 1rem;">ğŸ“Š Timeline</strong>
                <div class="timeline">
                  ${request.timeline.map(event => `
                    <div class="timeline-item">
                      <div class="timeline-time">${formatDate(event.timestamp)}</div>
                      <div class="timeline-content">${event.note}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          
          <div class="card-footer">
            ${request.status === 'requested' ? `
              <button class="btn btn-success" onclick="updateRequestStatus('${request.id}', 'confirmed')">
                âœ“ Accept Request
              </button>
              <button class="btn btn-danger" onclick="updateRequestStatus('${request.id}', 'cancelled')">
                âœ— Reject
              </button>
            ` : request.status === 'confirmed' ? `
              <button class="btn btn-success" onclick="updateRequestStatus('${request.id}', 'completed')">
                âœ“ Mark as Completed
              </button>
              <button class="btn btn-outline-sm" onclick="updateRequestStatus('${request.id}', 'cancelled')">
                Cancel Job
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }
    
    // Update request status
    window.updateRequestStatus = function(requestId, newStatus) {
      const statusMessages = {
        'confirmed': 'Are you sure you want to accept this request?',
        'completed': 'Mark this job as completed?',
        'cancelled': 'Are you sure you want to cancel this request?'
      };
      
      const confirmMessage = statusMessages[newStatus] || 'Update status?';
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      const noteMessages = {
        'confirmed': 'Accepted by provider',
        'completed': 'Work completed by provider',
        'cancelled': 'Cancelled by provider'
      };
      
      const note = noteMessages[newStatus] || 'Status updated';
      
      updateRequestStatus(requestId, newStatus, note);
      
      showNotification('Request updated successfully!', 'success');
      
      // Reload data
      loadStats();
      loadRequests();
      
      // If viewing history, reload that too
      const historyTab = document.getElementById('historyTab');
      if (historyTab.classList.contains('active')) {
        loadHistory();
      }
    };
    
    // Load history (completed and cancelled requests)
    function loadHistory() {
      const requests = getRequestsByProvider(currentUser.id)
        .filter(r => r.status === 'completed' || r.status === 'cancelled');
      
      const container = document.getElementById('historyList');
      const noMessage = document.getElementById('noHistoryMessage');
      
      if (requests.length === 0) {
        container.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
      }
      
      noMessage.classList.add('hidden');
      
      // Sort by most recent first
      requests.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      
      container.innerHTML = requests.map(request => `
        <div class="card" style="margin-bottom: 1rem;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h3 class="card-title" style="margin-bottom: 0.25rem;">ğŸ”§ ${request.service}</h3>
              <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Customer: <strong>${request.customerName}</strong></p>
            </div>
            ${getStatusBadge(request.status)}
          </div>
          
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 0.25rem;">Description</div>
                <div style="font-size: 0.9375rem; color: var(--text-primary);">${request.description}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 0.25rem;">Scheduled</div>
                <div style="font-size: 0.9375rem; color: var(--text-primary);">ğŸ“… ${formatDateOnly(request.preferredDate)} â° ${request.preferredTime}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 0.25rem;">Location</div>
                <div style="font-size: 0.9375rem; color: var(--text-primary);">ğŸ“ ${request.location}</div>
              </div>
            </div>
            <p style="font-size: 0.8125rem; color: var(--text-tertiary); margin: 1rem 0 0 0;">
              ${request.status === 'completed' ? 'âœ… Completed' : 'âŒ Cancelled'} on ${formatDate(request.updatedAt)}
            </p>
          </div>
        </div>
      `).join('');
    }
    
    // Load reviews
    function loadReviews() {
      const reviews = getReviewsByProvider(currentUser.id);
      const container = document.getElementById('reviewsList');
      const noMessage = document.getElementById('noReviewsMessage');
      
      if (reviews.length === 0) {
        container.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
      }
      
      noMessage.classList.add('hidden');
      
      // Sort by most recent first
      reviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      container.innerHTML = reviews.map(review => `
        <div class="card" style="margin-bottom: 1rem;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h3 class="card-title" style="margin-bottom: 0.25rem;">ğŸ‘¤ ${review.customerName}</h3>
              <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">${review.service}</p>
            </div>
            ${generateStarRating(review.rating)}
          </div>
          
          <div class="card-body">
            <p style="font-size: 1rem; line-height: 1.7; color: var(--text-primary);">${review.comment}</p>
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; align-items: center;">
              <p style="font-size: 0.8125rem; color: var(--text-tertiary); margin: 0;">
                Reviewed on ${formatDate(review.createdAt)}
              </p>
              
              ${review.sentiment ? `
                <span class="badge badge-${review.sentiment === 'positive' ? 'success' : review.sentiment === 'negative' ? 'danger' : 'secondary'}">
                  ${review.sentiment === 'positive' ? 'ğŸ˜Š' : review.sentiment === 'negative' ? 'ğŸ˜' : 'ğŸ˜'} ${review.sentiment}
                </span>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Load profile
    function loadProfile() {
      document.getElementById('profileName').textContent = currentUser.name;
      document.getElementById('profileEmail').textContent = currentUser.email;
      document.getElementById('profilePhone').textContent = currentUser.phone;
      document.getElementById('profileLocation').textContent = currentUser.location;
      document.getElementById('profileServices').textContent = currentUser.services ? currentUser.services.join(', ') : 'N/A';
      document.getElementById('profileAvailability').textContent = currentUser.availability || 'N/A';
      document.getElementById('profileStatus').innerHTML = getStatusBadge(currentUser.status);
      document.getElementById('profileMemberSince').textContent = formatDateOnly(currentUser.registeredAt);
      document.getElementById('profileBio').textContent = currentUser.bio || 'No description provided.';
    }
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');
        
        if (targetTab === 'requestsTab') {
          loadRequests();
        } else if (targetTab === 'historyTab') {
          loadHistory();
        } else if (targetTab === 'reviewsTab') {
          loadReviews();
        } else if (targetTab === 'profileTab') {
          loadProfile();
        }
      });
    });
    
    // Initial load
    loadStats();
    loadRequests();
  </script>
</body>
</html>
