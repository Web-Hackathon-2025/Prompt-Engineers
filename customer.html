<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - Karigar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container header-content">
      <a href="index.html" class="logo">üõ†Ô∏è Karigar</a>
      <div class="user-info">
        <span class="user-name" id="userName">Customer</span>
        <button class="btn btn-sm btn-outline" id="logoutBtn">Logout</button>
      </div>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <h1>Customer Dashboard</h1>
      <p style="color: var(--text-medium); margin-bottom: 2rem;">Find and book trusted local service providers</p>
      
      <!-- Tabs -->
      <div class="tabs" data-tabs>
        <button class="tab active" data-tab="browseTab">üîç Browse Services</button>
        <button class="tab" data-tab="bookingsTab">üìã My Bookings</button>
        <button class="tab" data-tab="reviewsTab">‚≠ê My Reviews</button>
      </div>
      
      <!-- Browse Services Tab -->
      <div id="browseTab" class="tab-content active">
        <!-- Search & Filters -->
        <div class="card">
          <div class="card-body">
            <div class="search-bar">
              <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="Search by service, name, or location..."
              >
              <select id="serviceFilter" class="form-select" style="min-width: 200px;">
                <option value="">All Services</option>
                <option value="Plumbing">Plumbing</option>
                <option value="Electrical">Electrical Work</option>
                <option value="Carpentry">Carpentry</option>
                <option value="House Cleaning">House Cleaning</option>
                <option value="Painting">Painting</option>
                <option value="Cooking">Cooking</option>
                <option value="AC Repair">AC Repair</option>
                <option value="Appliance Repair">Appliance Repair</option>
              </select>
            </div>
            
            <div class="flex-between" style="margin-top: 1rem;">
              <span id="providerCount" style="color: var(--text-medium);"></span>
              <label style="color: var(--text-medium); display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="nearMeFilter">
                Show only providers near me
              </label>
            </div>
          </div>
        </div>
        
        <!-- Provider Cards -->
        <div id="providerGrid" class="grid grid-2" style="margin-top: 1.5rem;">
          <!-- Dynamically populated -->
        </div>
        
        <div id="noProvidersMessage" class="empty-state hidden">
          <div class="empty-state-icon">üîç</div>
          <p class="empty-state-message">No service providers found matching your criteria.</p>
        </div>
      </div>
      
      <!-- My Bookings Tab -->
      <div id="bookingsTab" class="tab-content">
        <div id="bookingsList">
          <!-- Dynamically populated -->
        </div>
        
        <div id="noBookingsMessage" class="empty-state hidden">
          <div class="empty-state-icon">üìã</div>
          <p class="empty-state-message">You haven't made any booking requests yet.</p>
        </div>
      </div>
      
      <!-- My Reviews Tab -->
      <div id="reviewsTab" class="tab-content">
        <div id="reviewsList">
          <!-- Dynamically populated -->
        </div>
        
        <div id="noReviewsMessage" class="empty-state hidden">
          <div class="empty-state-icon">‚≠ê</div>
          <p class="empty-state-message">You haven't written any reviews yet.</p>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Book Service Modal -->
  <div id="bookServiceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalProviderName">Book Service</h3>
        <button class="modal-close" onclick="closeModal('bookServiceModal')">√ó</button>
      </div>
      
      <form id="bookServiceForm">
        <input type="hidden" id="bookProviderId">
        <input type="hidden" id="bookProviderName">
        
        <div class="form-group">
          <label class="form-label" for="bookService">Select Service *</label>
          <select id="bookService" class="form-select" required></select>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="bookDescription">Service Description *</label>
          <textarea 
            id="bookDescription" 
            class="form-textarea" 
            placeholder="Describe what you need help with..." 
            required
          ></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="bookDate">Preferred Date *</label>
          <input type="date" id="bookDate" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="bookTime">Preferred Time *</label>
          <input type="time" id="bookTime" class="form-input" required>
        </div>
        
        <div class="alert alert-info">
          <strong>üìã Note:</strong> Your request will be reviewed by admin before being sent to the provider.
        </div>
        
        <div class="card-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal('bookServiceModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Request</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Write Review Modal -->
  <div id="writeReviewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Write a Review</h3>
        <button class="modal-close" onclick="closeModal('writeReviewModal')">√ó</button>
      </div>
      
      <form id="writeReviewForm">
        <input type="hidden" id="reviewRequestId">
        <input type="hidden" id="reviewProviderId">
        <input type="hidden" id="reviewProviderName">
        <input type="hidden" id="reviewService">
        
        <div class="form-group">
          <label class="form-label">Rating *</label>
          <div class="rating" id="ratingStars" style="font-size: 2rem; cursor: pointer;">
            <span class="star" data-rating="1">‚òÜ</span>
            <span class="star" data-rating="2">‚òÜ</span>
            <span class="star" data-rating="3">‚òÜ</span>
            <span class="star" data-rating="4">‚òÜ</span>
            <span class="star" data-rating="5">‚òÜ</span>
          </div>
          <input type="hidden" id="reviewRating" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="reviewComment">Your Review *</label>
          <textarea 
            id="reviewComment" 
            class="form-textarea" 
            placeholder="Share your experience with this service provider..." 
            required
          ></textarea>
        </div>
        
        <div class="card-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal('writeReviewModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Review</button>
        </div>
      </form>
    </div>
  </div>
  
  <script src="data/users.js"></script>
  <script src="data/requests.js"></script>
  <script src="data/reviews.js"></script>
  <script src="ai/aiLogic.js"></script>
  <script src="script.js"></script>
  <script>
    // Check authentication
    const currentUser = getCurrentUser();
    if (!currentUser || currentUser.role !== 'customer') {
      window.location.href = 'index.html';
    }
    
    // Display user name
    document.getElementById('userName').textContent = currentUser.name;
    
    // Load providers
    let allProviders = [];
    let filteredProviders = [];
    
    function loadProviders() {
      allProviders = getUsersByRole('provider', 'active');
      filterProviders();
    }
    
    // Filter providers
    function filterProviders() {
      const searchQuery = document.getElementById('searchInput').value.trim();
      const serviceFilter = document.getElementById('serviceFilter').value;
      const nearMeFilter = document.getElementById('nearMeFilter').checked;
      
      filteredProviders = [...allProviders];
      
      // Filter by service
      if (serviceFilter) {
        filteredProviders = filteredProviders.filter(p => 
          p.services && p.services.includes(serviceFilter)
        );
      }
      
      // Filter by location
      if (nearMeFilter) {
        filteredProviders = filteredProviders.filter(p => 
          isLocationMatch(p.location, currentUser.location)
        );
      }
      
      // Filter by search query
      if (searchQuery) {
        filteredProviders = filterItems(filteredProviders, searchQuery, ['name', 'services', 'location', 'bio']);
      }
      
      // Rank providers using AI
      if (typeof rankProviders === 'function') {
        filteredProviders = rankProviders(filteredProviders, currentUser.location, serviceFilter);
      }
      
      displayProviders();
    }
    
    // Display providers
    function displayProviders() {
      const grid = document.getElementById('providerGrid');
      const noMessage = document.getElementById('noProvidersMessage');
      const countSpan = document.getElementById('providerCount');
      
      countSpan.textContent = `${filteredProviders.length} provider${filteredProviders.length !== 1 ? 's' : ''} found`;
      
      if (filteredProviders.length === 0) {
        grid.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
      }
      
      noMessage.classList.add('hidden');
      
      grid.innerHTML = filteredProviders.map(provider => {
        const reviews = getReviewsByProvider(provider.id);
        const avgRating = reviews.length > 0 ? getProviderAverageRating(provider.id) : provider.rating || 0;
        
        // Generate AI summary if available
        let aiSummary = '';
        if (typeof generateProviderSummary === 'function') {
          aiSummary = generateProviderSummary(provider);
        }
        
        return `
          <div class="card">
            <div class="card-header">
              <div>
                <h3 class="card-title">${provider.name}</h3>
                <p style="color: var(--text-medium); font-size: 0.9rem; margin: 0;">
                  üìç ${provider.location}
                </p>
              </div>
              ${generateStarRating(parseFloat(avgRating))}
            </div>
            
            <div class="card-body">
              ${aiSummary ? `
                <div class="alert alert-info" style="margin-bottom: 1rem; font-size: 0.85rem;">
                  <strong>ü§ñ AI Summary:</strong> ${aiSummary}
                </div>
              ` : ''}
              
              <p><strong>Services:</strong> ${provider.services.join(', ')}</p>
              
              ${provider.pricing && Object.keys(provider.pricing).length > 0 ? `
                <p><strong>Pricing:</strong><br>
                  ${Object.entries(provider.pricing).map(([service, price]) => 
                    `${service}: ${price}`
                  ).join('<br>')}
                </p>
              ` : ''}
              
              <p><strong>Availability:</strong> ${provider.availability}</p>
              
              <p style="font-size: 0.9rem; color: var(--text-medium);">${provider.bio}</p>
              
              <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <div>
                  <strong>${provider.completedJobs || 0}</strong>
                  <div style="font-size: 0.8rem; color: var(--text-light);">Jobs Done</div>
                </div>
                <div>
                  <strong>${reviews.length}</strong>
                  <div style="font-size: 0.8rem; color: var(--text-light);">Reviews</div>
                </div>
              </div>
            </div>
            
            <div class="card-footer">
              <button class="btn btn-primary" onclick="openBookModal('${provider.id}', '${provider.name}', ${JSON.stringify(provider.services).replace(/"/g, '&quot;')})">
                Book Service
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Open booking modal
    function openBookModal(providerId, providerName, services) {
      document.getElementById('bookProviderId').value = providerId;
      document.getElementById('bookProviderName').value = providerName;
      document.getElementById('modalProviderName').textContent = `Book Service - ${providerName}`;
      
      // Populate services dropdown
      const serviceSelect = document.getElementById('bookService');
      serviceSelect.innerHTML = services.map(service => 
        `<option value="${service}">${service}</option>`
      ).join('');
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('bookDate').min = today;
      
      openModal('bookServiceModal');
    }
    
    // Handle booking form
    document.getElementById('bookServiceForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const provider = getUserById(document.getElementById('bookProviderId').value);
      
      const requestData = {
        customerId: currentUser.id,
        providerId: provider.id,
        customerName: currentUser.name,
        providerName: provider.name,
        service: document.getElementById('bookService').value,
        description: document.getElementById('bookDescription').value.trim(),
        location: currentUser.location,
        preferredDate: document.getElementById('bookDate').value,
        preferredTime: document.getElementById('bookTime').value
      };
      
      addRequest(requestData);
      
      showNotification('Service request submitted! Awaiting admin approval.', 'success');
      closeModal('bookServiceModal');
      document.getElementById('bookServiceForm').reset();
      
      // Switch to bookings tab
      setTimeout(() => {
        document.querySelector('[data-tab="bookingsTab"]').click();
      }, 1000);
    });
    
    // Load bookings
    function loadBookings() {
      const bookings = getRequestsByCustomer(currentUser.id);
      const container = document.getElementById('bookingsList');
      const noMessage = document.getElementById('noBookingsMessage');
      
      if (bookings.length === 0) {
        container.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
      }
      
      noMessage.classList.add('hidden');
      
      // Sort by most recent first
      bookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      container.innerHTML = bookings.map(booking => `
        <div class="card">
          <div class="card-header">
            <div>
              <h3 class="card-title">${booking.service}</h3>
              <p style="color: var(--text-medium); margin: 0;">Provider: ${booking.providerName}</p>
            </div>
            ${getStatusBadge(booking.status)}
          </div>
          
          <div class="card-body">
            <p><strong>Description:</strong> ${booking.description}</p>
            <p><strong>Scheduled:</strong> ${formatDateOnly(booking.preferredDate)} at ${booking.preferredTime}</p>
            <p><strong>Location:</strong> ${booking.location}</p>
            <p style="font-size: 0.85rem; color: var(--text-light);">Requested on ${formatDate(booking.createdAt)}</p>
            
            ${booking.timeline && booking.timeline.length > 1 ? `
              <div style="margin-top: 1rem;">
                <strong>Timeline:</strong>
                <div class="timeline" style="margin-top: 0.5rem;">
                  ${booking.timeline.map(event => `
                    <div class="timeline-item">
                      <div class="timeline-time">${formatDate(event.timestamp)}</div>
                      <div class="timeline-content">${event.note}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          
          ${booking.status === 'completed' ? `
            <div class="card-footer">
              <button class="btn btn-secondary btn-sm" onclick="openReviewModal('${booking.id}', '${booking.providerId}', '${booking.providerName}', '${booking.service}')">
                Write Review
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }
    
    // Open review modal
    function openReviewModal(requestId, providerId, providerName, service) {
      // Check if already reviewed
      const existingReview = loadReviews().find(r => r.requestId === requestId);
      if (existingReview) {
        showNotification('You have already reviewed this service.', 'info');
        return;
      }
      
      document.getElementById('reviewRequestId').value = requestId;
      document.getElementById('reviewProviderId').value = providerId;
      document.getElementById('reviewProviderName').value = providerName;
      document.getElementById('reviewService').value = service;
      document.getElementById('reviewRating').value = '';
      
      // Reset stars
      document.querySelectorAll('#ratingStars .star').forEach(star => {
        star.textContent = '‚òÜ';
        star.classList.remove('selected');
      });
      
      openModal('writeReviewModal');
    }
    
    // Rating stars interaction
    document.getElementById('ratingStars').addEventListener('click', (e) => {
      if (e.target.classList.contains('star')) {
        const rating = parseInt(e.target.dataset.rating);
        document.getElementById('reviewRating').value = rating;
        
        // Update stars
        document.querySelectorAll('#ratingStars .star').forEach((star, index) => {
          if (index < rating) {
            star.textContent = '‚òÖ';
            star.classList.add('selected');
          } else {
            star.textContent = '‚òÜ';
            star.classList.remove('selected');
          }
        });
      }
    });
    
    // Handle review form
    document.getElementById('writeReviewForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const rating = parseInt(document.getElementById('reviewRating').value);
      if (!rating) {
        showNotification('Please select a rating', 'warning');
        return;
      }
      
      const reviewData = {
        requestId: document.getElementById('reviewRequestId').value,
        customerId: currentUser.id,
        providerId: document.getElementById('reviewProviderId').value,
        customerName: currentUser.name,
        providerName: document.getElementById('reviewProviderName').value,
        service: document.getElementById('reviewService').value,
        rating: rating,
        comment: document.getElementById('reviewComment').value.trim()
      };
      
      const newReview = addReview(reviewData);
      
      // Analyze sentiment with AI
      if (typeof analyzeSentiment === 'function') {
        const sentiment = analyzeSentiment(reviewData.comment);
        updateReview(newReview.id, { sentiment: sentiment.sentiment, flagged: sentiment.flagged });
      }
      
      showNotification('Review submitted successfully!', 'success');
      closeModal('writeReviewModal');
      document.getElementById('writeReviewForm').reset();
      
      // Reload reviews
      loadReviews();
      
      // Switch to reviews tab
      setTimeout(() => {
        document.querySelector('[data-tab="reviewsTab"]').click();
      }, 1000);
    });
    
    // Load customer reviews
    function loadCustomerReviews() {
      const reviews = getReviewsByCustomer(currentUser.id);
      const container = document.getElementById('reviewsList');
      const noMessage = document.getElementById('noReviewsMessage');
      
      if (reviews.length === 0) {
        container.innerHTML = '';
        noMessage.classList.remove('hidden');
        return;
      }
      
      noMessage.classList.add('hidden');
      
      // Sort by most recent first
      reviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      container.innerHTML = reviews.map(review => `
        <div class="card">
          <div class="card-header">
            <div>
              <h3 class="card-title">${review.providerName}</h3>
              <p style="color: var(--text-medium); margin: 0;">${review.service}</p>
            </div>
            ${generateStarRating(review.rating)}
          </div>
          
          <div class="card-body">
            <p>${review.comment}</p>
            <p style="font-size: 0.85rem; color: var(--text-light);">
              Reviewed on ${formatDate(review.createdAt)}
            </p>
            
            ${review.sentiment ? `
              <span class="badge badge-${review.sentiment === 'positive' ? 'success' : review.sentiment === 'negative' ? 'danger' : 'secondary'}">
                ${review.sentiment} sentiment
              </span>
            ` : ''}
            
            ${review.flagged ? `
              <span class="badge badge-warning">Flagged for review</span>
            ` : ''}
          </div>
        </div>
      `).join('');
    }
    
    // Event listeners for filtering
    document.getElementById('searchInput').addEventListener('input', filterProviders);
    document.getElementById('serviceFilter').addEventListener('change', filterProviders);
    document.getElementById('nearMeFilter').addEventListener('change', filterProviders);
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');
        
        if (targetTab === 'bookingsTab') {
          loadBookings();
        } else if (targetTab === 'reviewsTab') {
          loadCustomerReviews();
        }
      });
    });
    
    // Initial load
    loadProviders();
  </script>
</body>
</html>
